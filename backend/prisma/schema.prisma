generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = "mongodb://localhost:27017/echoroom?authSource=admin"
}

model User {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  email        String   @unique
  username     String   @unique
  passwordHash String
  role         UserRole @default(MEMBER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  refreshTokens RefreshToken[]
  likes         Like[]
}

model RefreshToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  token     String   @unique
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  expiresAt DateTime
  createdAt DateTime @default(now())
}

enum UserRole {
  ADMIN
  MODERATOR
  MEMBER
  GUEST
}

model Idea {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  status      String
  complexity  IdeaComplexity @default(MEDIUM)
  version     Int      @default(1)
  comments    Comment[]
  experiments Experiment[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  authorId    String? @db.ObjectId
  likes       Like[]
}

enum IdeaComplexity {
  LOW
  MEDIUM
  HIGH
}

model Experiment {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  hypothesis  String
  successMetric String
  falsifiability String
  status      String
  endDate     DateTime?
  linkedIdeaId String? @db.ObjectId
  linkedIdea   Idea?   @relation(fields: [linkedIdeaId], references: [id])
  outcomeResult String?
  outcomes    Outcome[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Outcome {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  experimentId  String   @db.ObjectId
  experiment    Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  result        String
  notes         String

  impactLevel   String?   // LOW | MODERATE | STRONG | BREAKTHROUGH
  wasExpected   Boolean?  // true / false
  momentum      String?   // RISING | STABLE | DROPPING

  reflections   Reflection[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Reflection {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  outcomeId String   @db.ObjectId
  outcome   Outcome  @relation(fields: [outcomeId], references: [id], onDelete: Cascade)
  context   Json
  breakdown Json
  growth    Json
  result    Json
  tags      String[]
  evidenceLink String
  visibility String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Comment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  ideaId    String   @db.ObjectId
  idea      Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  userId    String
  username  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Like {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  ideaId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  idea      Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, ideaId])
}
